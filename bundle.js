(()=>{"use strict";(()=>{const e="https://31.javascript.htmlacademy.pro/kekstagram/data",t="https://31.javascript.htmlacademy.pro/kekstagram",n=(n,o,i)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?n(r.response):o(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${r.timeout} мс.`)})),r.timeout=1e4,i?(r.open("POST",t),r.send(i)):(r.open("GET",e),r.send())};window.backend={load:n,upload:n}})(),(()=>{let e;window.utils={setDebounce:(t,n)=>{e&&window.clearTimeout(e),e=window.setTimeout(t,n)},shuffleArray:e=>{for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}}})(),(()=>{let e=[];const t=document.querySelector(".pictures"),n=document.querySelector(".img-filters"),o=document.querySelector("#picture").content.querySelector(".picture"),i=e=>{let n=document.createDocumentFragment();e.forEach((e=>{n.appendChild((e=>{let t=o.cloneNode(!0);t.querySelector(".picture__img").tabIndex=0,t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__img").alt=e.description,t.querySelector(".picture__comments").textContent=e.comments.length,t.querySelector(".picture__likes").textContent=e.likes;const n=e=>{"Escape"===e.code&&(e.preventDefault(),document.querySelector(".big-picture").classList.add("hidden"),document.body.classList.remove("modal-open"),window.bigpicture.clear(),document.removeEventListener("keydown",n))};return t.addEventListener("click",(t=>{t.preventDefault(),window.bigpicture.render(e),document.addEventListener("keydown",n)})),t})(e))})),t.appendChild(n)},r=document.querySelectorAll(".img-filters__button");let s=0;const d=(t,n)=>{t.preventDefault(),(e=>{let t=document.querySelector(".img-filters__button--active");t&&t.classList.remove("img-filters__button--active"),e.classList.add("img-filters__button--active")})(n),s=n.id;let o=e.slice();switch(s){case"filter-default":default:break;case"filter-random":window.utils.shuffleArray(o),o=o.slice(0,10);break;case"filter-discussed":o.sort(((e,t)=>t.comments.length-e.comments.length))}var r;r=o,document.querySelectorAll(".picture"),document.querySelectorAll(".picture").forEach((e=>{e.remove()})),window.utils.setDebounce(i(r),500)};r.forEach((e=>{e.addEventListener("click",(t=>{d(t,e)}))})),window.backend.load((t=>{e=t.slice(),i(e),n.classList.toggle("img-filters--inactive")}),(e=>{const t=document.createElement("div");t.style.padding="20px",t.style.backgroundColor="tomato",t.style.color="yellow",t.style.textAlign="center",t.prepend(`Не удалось загрузить изображения. ${e}`),window.mainTag.prepend(t)}))})(),window.bigpicture={render:e=>{const t=document.querySelector(".big-picture__preview"),n=t.querySelector(".big-picture__img > img");n.src=e.url,n.alt=e.description,t.querySelector(".likes-count").textContent=e.likes,t.querySelector(".comments-count").textContent=e.comments.length,t.querySelector(".social__caption").textContent=e.description,window.comment.render(e.comments),document.body.classList.add("modal-open"),document.querySelector(".big-picture").classList.remove("hidden");const o=e=>{e.preventDefault(),window.bigpicture.clear(),i.removeEventListener("click",o)},i=document.querySelector(".big-picture__cancel");i.addEventListener("click",o)},clear:()=>{document.body.classList.remove("modal-open");const e=document.querySelector(".social__comments-loader"),t=document.querySelector(".social__comment-count");e.classList.contains("hidden")&&e.classList.remove("hidden"),t.classList.contains("hidden")&&t.classList.remove("hidden"),document.querySelector(".big-picture").classList.add("hidden")}},window.comment={render:e=>{const t=document.querySelector(".social__comments"),n=document.querySelector(".social__comment"),o=document.querySelector(".social__comment-count"),i=document.querySelector(".social__comments-loader"),r=t=>{let o=n.cloneNode(!0),i=e[t].avatar,r=e[t].name,s=e[t].message;return o.querySelector(".social__picture").src=i,o.querySelector(".social__picture").alt=r,o.querySelector(".social__text").textContent=s,o},s=n=>{let s=document.createDocumentFragment();o.firstChild.textContent=`${n} из `;let d=n<=e.length?n:e.length;for(let t=0;t<d;t++)s.appendChild(r(t)),n>e.length&&i.classList.add("hidden");for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(s)};let d;if(e.length<5?(d=e.length,i.classList.add("hidden")):d=5,s(d),e.length>5){const t=n=>{n.preventDefault(),d+=5,s(d>=e.length?e.length:d),d>=e.length&&(i.classList.add("hidden"),i.removeEventListener("click",t))};i.addEventListener("click",t)}}},window.reset={setup:()=>{window.scaleControlValue.value="100%",window.scaleValue=parseInt(window.scaleControlValue.value,10),window.imagePreview.style.transform="scale(1)",window.imagePreview.classList.add("img-upload__preview"),window.imagePreview.classList.remove(window.imagePreview.classList[1]),window.imagePreview.style="",window.effectLevelValue.setAttribute("value","100"),window.effectLevelPin.style.left="100%",window.effectLevelDepth.style.width="100%",window.effectNone.checked=!0}},window.filter={apply:()=>{window.effectRadioInputs.forEach((e=>{e.addEventListener("click",(t=>{((e,t)=>{"effect-none"!==t.id?window.slider.classList.remove("hidden"):(window.slider.classList.add("hidden"),t.setAttribute("checked","")),(e=>{window.imagePreview.classList.remove(window.imagePreview.classList[1]),window.imagePreview.classList.add(`effects__preview--${e.value}`),window.saturation.reset(e),window.effectLevelValue.setAttribute("value","100"),document.querySelector(".effect-level__pin").style.left="100%",document.querySelector(".effect-level__depth").style.width="100%"})(t),document.removeEventListener("click",t)})(0,e)}))}))}},(()=>{const e="Escape";window.documentBody=document.querySelector("body"),window.mainTag=document.querySelector("main"),window.form=document.querySelector(".img-upload__form");const t=window.form.querySelector("#upload-file");window.previewOverlay=document.querySelector(".img-upload__overlay"),window.imagePreview=window.previewOverlay.querySelector(".img-upload__preview");const n=window.previewOverlay.querySelector("#upload-cancel");window.slider=window.previewOverlay.querySelector(".img-upload__effect-level"),window.effectRadioInputs=window.previewOverlay.querySelectorAll(".effects__radio"),window.effectNone=window.previewOverlay.querySelector("#effect-none"),window.hashtagInput=window.form.querySelector(".text__hashtags"),window.textArea=window.form.querySelector(".text__description"),t.addEventListener("change",(()=>{window.previewOverlay.classList.remove("hidden"),window.documentBody.classList.add("modal-open"),window.effectNone.hasAttribute("checked")&&window.slider.classList.add("hidden"),window.reset.setup(),document.addEventListener("keydown",o)})),window.filter.apply(),window.form.addEventListener("submit",(e=>{e.preventDefault(),window.backend.upload((()=>{window.previewOverlay.classList.add("hidden"),window.message.render("success"),window.reset.setup(),document.addEventListener("keydown",d),window.form.reset()}),(()=>{window.previewOverlay.classList.add("hidden"),window.message.render("error"),window.reset.setup(),document.addEventListener("keydown",l)}),new FormData(window.form)),window.form.reset()})),n.addEventListener("click",(e=>{e.preventDefault(),window.previewOverlay.classList.add("hidden"),window.documentBody.classList.remove("modal-open"),window.form.reset(),window.reset.setup()}));const o=t=>{t.code===e&&(t.preventDefault(),window.previewOverlay.classList.add("hidden"),window.documentBody.classList.remove("modal-open"),window.form.reset(),window.reset.setup())},i=()=>{document.removeEventListener("keydown",o)},r=()=>{document.addEventListener("keydown",o)};window.hashtagInput.addEventListener("focus",i),window.hashtagInput.addEventListener("blur",r),window.textArea.addEventListener("focus",i),window.textArea.addEventListener("blur",r);const s=(e,t)=>{document.querySelector(`.${e}`).remove(),document.removeEventListener("keydown",t)},d=t=>{t.code===e&&(t.preventDefault(),s("success",d))},l=t=>{t.code===e&&(t.preventDefault(),s("error",l))}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__preview img"),o=document.querySelectorAll(".effects__preview");t.addEventListener("change",(()=>{const i=t.files[0],r=i.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader,t=()=>{n.src=e.result,o.forEach((t=>{t.style.backgroundImage=`url(${e.result})`}))};e.addEventListener("load",t),e.readAsDataURL(i)}}))})(),(()=>{const e=window.form.querySelector(".scale__control--smaller"),t=window.form.querySelector(".scale__control--bigger");window.scaleControlValue=window.form.querySelector(".scale__control--value"),window.scaleControlValue.value="100%",window.scaleValue=parseInt(window.scaleControlValue.value,10);const n=e=>{window.scaleControlValue.value=`${e}%`,window.imagePreview.style.transform=`scale(${e/100})`};e.addEventListener("click",(e=>{e.preventDefault(),25!==window.scaleValue&&window.scaleValue<=100&&(window.scaleValue-=25),n(window.scaleValue)})),t.addEventListener("click",(e=>{e.preventDefault(),window.scaleValue>=25&&window.scaleValue<100&&(window.scaleValue+=25),n(window.scaleValue)}))})(),(()=>{const e=window.previewOverlay.querySelector(".effect-level__line");window.effectLevelValue=window.previewOverlay.querySelector("input[name=effect-level]"),window.effectLevelPin=window.previewOverlay.querySelector(".effect-level__pin"),window.effectLevelDepth=window.previewOverlay.querySelector(".effect-level__depth"),window.effectLevelPin.addEventListener("mousedown",(t=>{t.preventDefault();let n={x:t.clientX};const o=e.getBoundingClientRect(),i=e.offsetWidth;let r=e=>{e.preventDefault(),n={x:e.clientX};let t=n.x-o.left;t<0?t=0:t>i&&(t=i);const r=t/i*100;switch(window.effectLevelValue.setAttribute("value",`${parseInt(r,10)}`),window.effectLevelPin.style.left=`${t}px`,window.effectLevelDepth.style.width=`${r}%`,window.imagePreview.classList[1]){case"effects__preview--chrome":window.imagePreview.style.filter=`grayscale(${window.effectLevelValue.value/100})`;break;case"effects__preview--sepia":window.imagePreview.style.filter=`sepia(${window.effectLevelValue.value/100})`;break;case"effects__preview--marvin":window.imagePreview.style.filter=`invert(${window.effectLevelValue.value}%)`;break;case"effects__preview--phobos":window.imagePreview.style.filter=`blur(${.03*window.effectLevelValue.value}px)`;break;case"effects__preview--heat":window.imagePreview.style.filter=`brightness(${1+.02*window.effectLevelValue.value})`;break;default:window.imagePreview.style.filter=""}},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)}))})(),window.saturation={reset:e=>{switch(e.value){case"chrome":window.imagePreview.style.filter="grayscale(1)";break;case"sepia":window.imagePreview.style.filter="sepia(1)";break;case"marvin":window.imagePreview.style.filter="invert(100%)";break;case"phobos":window.imagePreview.style.filter="blur(3px)";break;case"heat":window.imagePreview.style.filter="brightness(3)";break;default:window.imagePreview.style.filter=""}}},window.hashtagInput.addEventListener("input",(()=>{const e=[],t=window.hashtagInput.value.toLowerCase().trim();if(!t)return void window.hashtagInput.setCustomValidity("");const n=t.split(/\s+/);if(0===n.length)return;n.some((e=>"#"!==e[0]))&&e.push("Хэш-тег должен начинаться с символа #"),n.some((e=>"#"===e))&&e.push("Хеш-тег не может состоять только из одной решётки");const o=new RegExp("[^#а-яёa-z0-9]","i");n.forEach((t=>{o.test(t)&&e.push("Хэш-тег может содержать только буквы и числа без пробелов")})),n.some((e=>e.indexOf("#",1)>=1))&&e.push("Хэш-теги разделяются пробелами"),n.some(((e,t,n)=>n.indexOf(e,t+1)>=t+1))&&e.push("Один и тот же хэш-тег не может быть использован дважды"),n.some((e=>e.length>20))&&e.push("Максимальная длина одного хэш-тега 20 символов, включая решётку"),n.length>5&&e.push("Нельзя указать больше пяти хэш-тегов"),window.hashtagInput.setCustomValidity(e.join(". \n")),e.length>0?(window.hashtagInput.setCustomValidity(e.join(". \n")),window.hashtagInput.style.outlineColor="red"):window.hashtagInput.style.outlineColor=""})),(()=>{const e=t=>{t.preventDefault();const n=[],o=window.textArea.value.toLowerCase();if(!o)return n.splice(0,n.length),void window.textArea.setCustomValidity("");0!==o.split(/\s+/).length&&(o.length>140&&n.push(`Длина комментария не может составлять больше 140 символов. Удалите ${Math.abs(140-o.length)} симв.`),window.textArea.setCustomValidity(n.join(". \n")),n.length>0?(window.textArea.setCustomValidity(n.join(". \n")),window.textArea.style.outlineColor="red"):window.textArea.style.outlineColor="",document.removeEventListener("input",e))};window.textArea.addEventListener("input",e)})(),(()=>{const e="Escape";window.message={render:t=>{if("success"===t){const t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=e=>{e.preventDefault(),t.remove(),window.documentBody.classList.remove("modal-open"),document.removeEventListener("click",n)},o=e=>{e.preventDefault(),e.target.classList.contains("success")&&(t.remove(),window.documentBody.classList.remove("modal-open"),document.removeEventListener("click",o))},i=n=>{n.code===e&&(n.preventDefault(),n.target.classList.contains("success")&&(t.remove(),window.documentBody.classList.remove("modal-open")),document.removeEventListener("keydown",i))};(()=>{let e=document.createDocumentFragment();e.appendChild(t),window.mainTag.appendChild(e),document.querySelector(".success__button").addEventListener("click",n);const r=document.querySelector(".success");r.addEventListener("click",o),r.addEventListener("keydown",i)})()}else{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),n=e=>{e.preventDefault(),t.remove(),window.documentBody.classList.remove("modal-open"),document.removeEventListener("click",n)},o=e=>{e.preventDefault(),e.target.classList.contains("error")&&t.remove(),document.removeEventListener("click",o)},i=n=>{n.code===e&&(n.preventDefault(),n.target.classList.contains("error")&&t.remove(),document.removeEventListener("keydown",i))};(()=>{let e=document.createDocumentFragment();e.appendChild(t),window.mainTag.appendChild(e),document.querySelector(".error__button").addEventListener("click",n);const r=document.querySelector(".error");r.addEventListener("click",o),r.addEventListener("keydown",i)})()}}}})()})();